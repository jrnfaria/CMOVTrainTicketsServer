var requests = require('config/requests');
var request = require('request');

var fs = require("fs");
var file = "traintickets.db";
var exists = fs.existsSync(file);

var sqlite3 = require("sqlite3").verbose();
var db = new sqlite3.Database(file);

if(!exists)
{
    console.log("Creating database file...");
    fs.openSync(file, "w");
    db.run("CREATE TABLE USER (NAME TEXT, USERNAME TEXT, PASSWORD TEXT)");
    db.run("CREATE TABLE CREDITCARD (TYPE TEXT, NUMBER INT, VALIDITY TEXT, USER REFERENCES USER(USERNAME))");
    db.run("CREATE TABLE TICKET(ID INTEGER, DEPARTURE TEXT, ARRIVAL TEXT, TRAIN TEXT, DEPARTUREDATE TEXT, USER REFERENCES USER(USERNAME))");
    console.log("Done!");
}

exports.signup = function(name, username, password, creditcardtype, creditcardnumber, creditcardvalidity, callback)
{
    var stmt = db.prepare("INSERT INTO USER VALUES ($name, $username, $password)");
    stmt.bind({$name:name, $username:username, $password:password});
    stmt.run();
    stmt.finalize();
    stmt = db.prepare("INSERT INTO CREDITCARD VALUES ($creditcardtype, $creditcardnumber, $creditcardvalidity, $username)");
    stmt.bind({$creditcardtype:creditcardtype, $creditcardnumber:creditcardnumber, $creditcardvalidity:creditcardvalidity, $username:username});
    stmt.run();
    stmt.finalize();

    callback({'response': "OK"});
}

exports.signin = function(username, password, callback)
{
    requests.users(function(users)
    {
        var found = 0;

        for(var i = 0; i < users.length; i++) {
            if(users[i].USERNAME == username && users[i].PASSWORD == password)
                found = 1;
        }

        if(found == 1)
            callback({'response': "OK"});
        else
            callback({'response': "ERROR"});
    });
}

exports.buyticket = function(id, departure, arrival, train, departuredate, username, callback)
{
    var stmt = db.prepare("INSERT INTO TICKET VALUES ($id, $departure, $arrival, $train, $departuredate, $username)");
    stmt.bind({$id:id, $departure:departure, $arrival:arrival, $train:train, $departuredate:departuredate, $username:username});
    stmt.run();
    stmt.finalize();

    callback({'response': "OK"});
}

exports.mytickets = function(username, callback)
{
    db.all("SELECT * FROM TICKET WHERE USER=?", [username], function(err, rows) {
        callback(rows);
    });
}

exports.users = function(callback)
{
    db.all("SELECT * FROM USER", function(err, rows) {
        callback(rows);
    });
}
